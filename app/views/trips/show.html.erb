<h1><%= @trip.name %></h1>
<p><strong>Start:</strong> <%= @trip.start_date %></p>
<p><strong>End:</strong> <%= @trip.end_date %></p>

<h2>Participants</h2>
<ul>
  <% @trip.participants.each do |p| %>
    <li><%= p.name %> (<%= p.email %>)</li>
  <% end %>
</ul>

<%= link_to 'Back to Trips', trips_path, class: 'btn btn-secondary' %>
<%= link_to "Add Expense", new_trip_expense_path(@trip), class: "btn btn-primary" %> <!-- opens expense form -->
<%= link_to "Edit Trip", edit_trip_path(@trip), class: "btn btn-secondary" %>

<h2>Expenses</h2>
<% @trip.expenses.each do |expense| %>
  <p>
    <strong><%= expense.payer_name %></strong> paid
    $<%= expense.amount %> for
    <%= expense.description %> on
    <%= expense.date&.strftime("%b %d, %Y") %>
    (<%= pluralize(expense.participants.count, "person") %> shared)

    <%= link_to "Edit", edit_trip_expense_path(@trip, expense), class: "btn btn-sm btn-outline-warning" %>
    <%= button_to "Delete", trip_expense_path(@trip, expense),
      method: :delete,
      data: { confirm: "Are you sure you want to delete this expense?" },
      class: "btn btn-sm btn-outline-danger" %>

  </p>
<% end %>

<%= link_to "View Expense Breakdown", expense_breakdown_trip_path(@trip), class: "btn btn-info" %>

<script>
  document.getElementById("toggle-chart").addEventListener("click", function () {
    const canvas = document.getElementById("expenseChart");
    canvas.style.display = canvas.style.display === "none" ? "block" : "none";

    if (!window.expenseChartInitialized) {
      const ctx = canvas.getContext("2d");

      const chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: <%= raw @category_totals.keys.to_json %>,
          datasets: [{
            label: "Expenses by Category",
            data: <%= raw @category_totals.values.to_json %>,
            backgroundColor: [
              "#4e79a7", "#f28e2c", "#e15759", "#76b7b2", "#59a14f", "#edc948"
            ]
          }]
        }
      });

      window.expenseChartInitialized = true;
    }
  });
</script>



<h3>Participant Balances</h3>
<ul>
  <% @trip.participants.each do |p| %>
    <% total_paid = @trip.expenses.where(payer_name: p.name).sum(:amount) %>
    <% total_owed = @trip.expenses.joins(:participants).where(participants: { id: p.id }).sum("expenses.amount") / @trip.expenses.joins(:participants).where(participants: { id: p.id }).count.to_f rescue 0 %>

    <li><strong><%= p.name %></strong> paid $<%= total_paid.round(2) %></li>
  <% end %>
</ul>


<h2>Who Owes What</h2>

<% @settlements.each do |transaction| %>
  <p><%= transaction %></p>
<% end %>
