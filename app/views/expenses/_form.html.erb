<%= form_with model: [@trip, @expense], local: true do |f| %>
  <% if @expense.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h5 class="alert-heading">Please fix the following errors:</h5>
      <ul>
        <% @expense.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <div class="mb-3">
    <%= f.label :description, class: "form-label" %>
    <%= f.text_field :description, class: "form-control", required: true %>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <%= f.label :amount, class: "form-label" %>
      <%= f.number_field :amount, step: "0.01", class: "form-control", required: true, min: 0.01 %>
    </div>
    <div class="col-md-6">
      <%= f.label :date, class: "form-label" %>
      <%= f.date_field :date, min: @trip.start_date, max: @trip.end_date, class: "form-control", required: true %>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <%= f.label :payer_id, "Paid By", class: "form-label" %>
      <%# Note: We might need to add logic to fetch @potential_payers in the controller edit action too %>
      <%= f.collection_select :payer_id, @potential_payers, :id, :email, { prompt: "Select Payer" }, { class: "form-select", required: true } %>
      <% if @potential_payers.empty? %>
        <p class="text-muted small mt-1">No registered users found among participants to select as payer.</p>
      <% end %>
    </div>
    <div class="col-md-6">
      <%= f.label :category, class: "form-label" %>
      <%= f.select :category, ["Food", "Lodging", "Transportation", "Entertainment", "Other"], { prompt: "Select Category" }, { class: "form-select" } %>
    </div>
  </div>

  <div class="mb-3">
    <%= f.label :participant_ids, "Shared With (select at least one):", class: "form-label d-block mb-2" %>
    <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
      <%= f.collection_check_boxes :participant_ids, @trip.participants, :id, :name do |b| %>
        <div class="form-check">
          <%= b.check_box(class: "form-check-input") %>
          <%= b.label(class: "form-check-label") %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="text-end">
    <%= f.submit "Save Expense", class: "btn btn-primary" %>
  </div>
<% end %>
